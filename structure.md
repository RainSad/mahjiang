# 自动打麻将程序架构设计

## 一、项目设计目标

1. **模块化设计**：支持多种麻将规则的扩展
2. **逻辑分离**：游戏逻辑、出牌逻辑、危险牌预测等独立实现
3. **可扩展性**：便于后续添加新的麻将打法
4. **清晰的目录结构**：每个麻将打法独立存放
5. **可测试性**：便于单元测试和集成测试

## 二、目录结构设计

```
mahjiang/
├── src/
│   ├── core/                  # 核心模块（与具体规则无关）
│   │   ├── data/              # 核心数据结构
│   │   │   ├── card.py        # 牌类定义
│   │   │   ├── player.py      # 玩家类定义
│   │   │   ├── game_state.py  # 游戏状态类定义
│   │   │   └── action.py      # 操作类定义
│   │   ├── logic/             # 通用游戏逻辑
│   │   │   ├── game_flow.py   # 游戏流程控制
│   │   │   ├── deck_manager.py # 牌墙管理
│   │   │   └── turn_handler.py # 回合处理
│   │   └── utils/             # 通用工具函数
│   │       ├── logger.py      # 日志管理
│   │       └── helper.py      # 辅助函数
│   ├── rules/                 # 麻将规则模块（每种规则独立目录）
│   │   ├── base_rule.py       # 规则基类
│   │   ├── tencent_common/    # 腾讯大众麻将规则
│   │   │   ├── rule.py        # 核心规则实现
│   │   │   ├── hu_rules.py    # 胡牌规则
│   │   │   ├── action_rules.py # 操作规则
│   │   │   └── score_rules.py # 计分规则
│   │   └── guobiao/           # 国标麻将规则（预留）
│   ├── ai/                    # AI决策系统
│   │   ├── base_ai.py         # AI基类
│   │   ├── strategy/          # 策略算法
│   │   │   ├── base_strategy.py # 策略基类
│   │   │   ├── simple_strategy.py # 简单策略
│   │   │   └── advanced_strategy.py # 高级策略
│   │   ├── evaluation/        # 评估模块
│   │   │   ├── hand_evaluator.py # 手牌评估
│   │   │   ├── risk_evaluator.py # 危险牌预测
│   │   │   └── value_evaluator.py # 价值评估
│   │   └── decision.py        # 决策核心
│   ├── interface/             # 外部接口
│   │   ├── game_api.py        # 游戏控制接口
│   │   └── result_api.py      # 结果查询接口
│   └── ui/                    # 可选的用户界面
│       ├── base_ui.py         # UI基类
│       └── terminal_ui.py     # 终端界面
├── tests/                     # 测试代码
│   ├── core/                  # 核心模块测试
│   ├── rules/                 # 规则测试
│   └── ai/                    # AI模块测试
├── docs/                      # 文档
├── config/                    # 配置文件
├── requirements.txt           # 依赖列表
└── main.py                    # 程序入口


### 1. 用牌规则
- 实现情况 ：✅ 正确实现了144张牌的组成（108张序数牌、28张字牌、8张花牌）
### 2. 开局规则
- 换牌功能 ：❌ 未实现（规则要求发完手牌后可选择至多5张牌与系统换牌）
- 跟庄功能 ：❌ 未实现（规则要求庄家打出第一张牌后，若这一巡闲家都打出相同牌且无吃碰杠，庄家需立即赔付豆子）
### 3. 行牌规则
- 碰、杠、吃上家牌 ：✅ 基本实现
- 补花功能 ：❌ 仅在注释中提到，未实现完整逻辑
- 补牌功能 ：❌ 未实现（规则要求补花/杠牌后，可从牌山随机3张牌选1张放入手牌）
- 杠开、杠上开花、杠上炮 ：❌ 有定义但仅返回False，未实现具体逻辑
- 连杠功能 ：❌ 未实现（规则要求一个操作回合内连续杠牌/补花且无其他操作，连杠次数越多，杠开收益越高、杠上炮输分也越高）
- 接杠功能 ：❌ 未实现（规则要求杠牌后打出的牌被其他玩家杠，连杠次数由该玩家继承）
- 庄家输赢×2倍 ：❌ 未实现
- 场风 ：⚠️ 有相关代码但需确保默认是东风场
- 门风 ：⚠️ 有相关代码但需确保正确实现
### 4. 胡牌规则
- 至少1种番型才能吃胡 ：✅ 已实现
- 鸡胡只能自摸 ：❌ 未实现（规则要求鸡胡只能自摸）
- 特殊胡牌番型 ：❌ 抢杠胡、杠上炮、杠上开花有定义但仅返回False，未实现具体逻辑
### 5. 计分规则
- 番型累加 ：✅ 已实现
- 翻倍 ：⚠️ 有杠上开花等翻倍番型但未完整实现
- 底分 ：⚠️ 代码中使用基础分1，未看到底分配置（规则要求得分计算公式：（番型1 + 番型2 +…）×翻倍×底分）
### 6. 特殊规则
- 三滩承包 ：❌ 未实现（规则要求若玩家给另一个玩家吃/碰/杠3次，需承包该玩家所有赢分，仅在土豪场生效）

- 优先实现基础的行牌规则和胡牌逻辑
- 完善计分规则，确保庄家翻倍等核心功能
- 逐步实现特殊规则如连杠、三滩承包等
- 最后实现开局规则中的换牌和跟庄功能

## 五、技术选型

| 模块 | 技术/框架 | 理由 |
|------|-----------|------|
| 编程语言 | Python 3.8+ | 开发效率高，适合快速原型开发；有丰富的数学计算和算法库；语法简洁，易于维护和扩展；可跨平台运行 |
| 核心逻辑 | 纯Python | 无需外部依赖，便于维护和部署 |
| 数学计算 | numpy | 高效的数值计算支持，适合概率计算和AI算法 |
| 随机数生成 | random模块 | 内置随机数生成器，满足游戏需求 |
| 日志管理 | logging模块 | 内置日志系统，配置灵活 |
| 测试框架 | pytest | 强大的测试框架，支持单元测试和集成测试 |
| 类型检查 | mypy | 静态类型检查，提高代码质量 |
| UI框架（可选） | Tkinter/PyQt | 跨平台GUI支持，便于开发可视化界面 |
| 性能优化 | Cython/numba | 关键算法的性能加速，提高AI决策速度 |

## 六、实现计划

### 第一阶段（2-3周）：核心框架搭建
1. 实现核心数据结构（Card, Player, GameState, Action）
2. 实现基础规则基类和框架
3. 实现腾讯大众麻将规则核心功能
4. 实现基本的游戏流程控制
5. 编写单元测试

### 第二阶段（2-3周）：AI决策系统开发
1. 实现基础AI策略
2. 实现危险牌预测模块
3. 实现手牌评估模块
4. 优化AI决策算法
5. 编写AI相关测试

### 第三阶段（1-2周）：功能完善和测试
1. 完善腾讯大众麻将规则的所有功能
2. 实现游戏控制接口
3. 编写集成测试
4. 修复bug和性能优化

### 第四阶段（可选，2-4周）：高级功能开发
1. 开发可视化界面
2. 支持多种规则切换
3. 实现AI难度分级
4. 添加统计分析功能

## 七、扩展性考虑

1. **规则扩展**：通过继承BaseRule类，可以轻松添加新的麻将规则
2. **AI策略扩展**：通过继承BaseStrategy类，可以添加新的AI策略
3. **界面扩展**：通过继承BaseUI类，可以添加新的用户界面
4. **功能扩展**：通过模块化设计，可以方便地添加新功能，如联网对战、回放等

## 八、重点难点分析

### 1. 规则系统设计
- **挑战**：不同麻将规则差异很大，需要一个灵活的规则框架
- **解决方案**：采用抽象基类+具体实现的方式，每种规则独立实现；将规则分解为胡牌规则、操作规则、计分规则等子模块

### 2. 胡牌判定算法
- **挑战**：需要高效判断各种复杂牌型的胡牌条件
- **解决方案**：实现基于动态规划的通用胡牌判定算法，支持基本牌型和特殊牌型

### 3. 危险牌预测
- **挑战**：需要准确评估打出某张牌的风险
- **解决方案**：结合概率计算、对手行为分析和牌型价值评估，采用分层评估策略

### 4. AI决策系统
- **挑战**：麻将是不完全信息博弈，需要考虑多种因素
- **解决方案**：采用分层决策架构，从简单到复杂逐步优化；结合规则引擎和机器学习算法

## 九、测试策略

1. **单元测试**：测试每个核心类和方法的功能，使用pytest进行测试
2. **规则测试**：针对每种规则的核心功能进行测试，确保规则的正确性
3. **AI测试**：测试AI决策的合理性和性能，使用模拟对局进行测试
4. **集成测试**：测试整个游戏流程的完整性，确保各模块协同工作正常
5. **性能测试**：测试AI决策的速度和资源占用，优化关键算法

## 十、部署和运行

### 运行方式
```bash
# 终端运行
python main.py --rule tencent_common --players ai,ai,ai,ai

# 使用配置文件运行
python main.py --config config/tencent_common.json
```


## 十一、总结

本架构设计采用了模块化、可扩展的设计理念，将麻将游戏的核心功能分解为多个独立模块，便于维护和扩展。重点实现了规则系统的灵活性，支持多种麻将规则的扩展；AI决策系统采用分层设计，支持不同水平的AI策略；危险牌预测模块结合多种因素进行风险评估，提高AI的决策质量。

通过清晰的目录结构和接口设计，确保了代码的可读性和可维护性，便于后续功能的扩展和优化。




规则分类,具体规则内容,
用牌规则,总计144张牌，包含：1. 序数牌：1-9万、1-9筒、1-9条（每种4张，共108张）2. 字牌：东南西北中发白（每种4张，共28张）3. 花牌：梅兰竹菊春夏秋冬（每种1张，共8张）,
开局规则,1. 换牌：发完手牌后，玩家可选择至多5张牌与系统换牌2. 跟庄：庄家打出第一张牌后，若这一巡闲家都打出相同牌且无吃碰杠，庄家需立即赔付豆子,
行牌规则,1. 可碰、杠，吃上家的牌2. 补花：摸到花牌可择机自行打出并补花3. 补牌：补花/杠牌后，可从牌山随机3张牌选1张放入手牌4. 杠开：补花/杠牌后补牌自摸，达成杠上开花5. 连杠：一个操作回合内连续杠牌/补花且无其他操作，连杠次数越多，杠开收益越高、杠上炮输分也越高6. 接杠：杠牌后打出的牌被其他玩家杠，连杠次数由该玩家继承7. 庄家：每局坐东方位的为庄家，庄家输赢×2倍8. 场风：非好友房均为东风场，东风的刻子为场风刻9. 门风：自己所坐方位即为门风（如庄家东风位，门风为东），对应门风的刻子为门风刻,
胡牌规则,1. 必须满足至少1种番型才能吃胡，鸡胡只能自摸2. 补花和庄赢不属于番型3. 抢杠胡、杠上炮、杠上开花属于番型,
计分规则,得分计算公式：（番型1 + 番型2 +…）×翻倍×底分,
特殊规则,三滩承包：若玩家给另一个玩家吃/碰/杠3次，需承包该玩家所有赢分（仅在土豪场生效）

番数,番型名称,简要说明,
88番,大四喜,4副风刻（杠）组成的胡牌。,
88番,大三元,胡牌中含有中、发、白3副刻子。,
88番,十三幺,由3种序数牌的一、九牌，七种字牌及其中一对作将组成的胡牌。,
88番,天胡,庄家在发完牌后直接胡牌。,
88番,地胡,非庄家在第一轮摸牌后立即自摸胡牌。,
88番,大七星,由七种字牌组成的七对。,
88番,九莲宝灯,一种花色的1112345678999牌型，见同花色任意一张序数牌即可胡牌。,
88番,十八罗汉,胡牌时手中有4副杠牌。,
88番,连七对,由同一花色序数牌组成的序数相连的7个对子。,
88番,绿一色,由2、3、4、6、8条及发财组成的胡牌。,
64番,小四喜,胡牌时有风牌的3副刻子及1对将牌。,
64番,小三元,胡牌时有箭牌的2副刻子及1对将牌。,
64番,字一色,由字牌的刻子（杠）、将组成的胡牌。,
64番,四暗刻,4个暗刻（暗杠）组成的胡牌。,
64番,一色双龙会,一种花色的两个老少副，5为将牌。,
64番,清幺九,只由序数牌一、九组成的胡牌。,
64番,人胡,非庄家发完牌后第一轮就吃胡。,
48番,四同顺,一种花色4副序数相同的顺子。,
48番,四连刻,一种花色4副依次递增一位数的刻子。,
36番,一色四步高,一种花色4副依次递增一位数或二位数的顺子。,
36番,十二金钗,胡牌时手中有3副杠牌。,
36番,混幺九,由序数牌一、九和字牌组成的胡牌。,
32番,七对,由7个对子组成的胡牌。,
32番,清一色,只由一种花色序数牌组成的胡牌。,
32番,全双刻,胡牌时手牌都是双数的序数牌。,
32番,全大,胡牌时手牌都是七、八、九的序数牌。,
32番,全中,胡牌时手牌都是四、五、六的序数牌。,
32番,全小,胡牌时手牌都是一、二、三的序数牌。,
32番,三连刻,一种花色3副依次递增一位数字的刻子。,
32番,三同顺,一种花色3副序数相同的顺子。,
24番,清龙,一种花色1-9相连的序数牌。,
24番,一色三步高,一种花色3副依次递增一位数或二位数的顺子。,
24番,三同刻,3个序数相同的刻子（杠）。,
24番,三暗刻,胡牌时包含3个暗刻。,
24番,七星不靠,有7个单张的东南西北中发白，加3种花色按147、258、369组合的牌。,
16番,推不倒,由牌面图形无上下区别的牌组成的胡牌。,
16番,纯带幺九,胡牌时每副牌、将牌都包含一或九的序数牌。,
16番,三风刻,胡牌时包含3副风刻。,
16番,全单,胡牌时手牌都是单数的序数牌。,
12番,五门齐,胡牌时3种序数牌、风、箭牌齐全。,
12番,碰碰胡,由4副刻子（或杠）、将牌组成的胡牌。,
12番,双箭刻,胡牌时有2副箭刻（或杠）。,
12番,花龙,3种花色的3副顺子连接成1-9的序数牌。,
12番,组合龙,包含3种花色的147、258、369的9张序数牌。,
12番,全不靠,由单张3种花色的147、258、369序数牌及字牌中任意14张组成。,
12番,三色三同顺,胡牌时有3种花色3副序数相同的顺子。,
8番,金钩钓,牌被吃碰杠放倒后只剩1张牌单钓将胡牌。,
8番,带幺九,胡牌时每副牌、将牌都有一、九序数牌或字牌。,
8番,混一色,由一种花色序数牌+字牌组成的胡牌。,
4番,断幺九,胡牌中无1、9序数牌及字牌。,
4番,一般高,由一种花色2副相同的顺子组成。,
4番,喜相逢,2种花色2副序数相同的顺子。,
4番,连六,胡牌时有6张同一花色序数相连的牌组成2副顺子。,
4番,老少副,一种花色的123、789两副顺子。,
4番,箭刻,手中有一副中、发、白的箭刻。,
4番,场风刻,手中有一副东风的场风刻子。,
4番,门风刻,手中有一副与本门风相同的风刻。,
4番,暗杠,自己摸到4张相同的牌开杠。,
4番,四归一,包含4张相同的牌胡牌（不能杠出）。,
4番,门清,胡牌时无吃碰和明杠。,
4番,双暗刻,胡牌时有2个暗刻。,
4番,双同刻,胡牌时有2副序数相同的刻子。,
2番,四花,胡牌时补花数量≥4张。,
2番,明杠,自己有暗刻，碰别人打出的相同牌开杠；或抓进与碰的明刻相同的牌开杠。,
1番,自摸,自己抓进牌成胡牌。,
×2倍,杠上开花,杠牌/补花后摸牌胡牌。,
×2倍,妙手回春,自摸牌墙最后一张牌胡牌（不计自摸）。,
×2倍,海底捞月,胡打出的最后一张牌。,
×2倍,抢杠胡,胡别人补杠的那张牌。,
×2倍,杠上炮,胡别人杠牌后打出的那张牌。